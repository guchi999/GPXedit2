<!DOCTYPE html>
<html lang="ja" >
  <head>
    <meta charset="utf-8">
    <title>GPXEdit 使い方</title>
    <style>
    </style>
  </head>
  <body>

<span id="top"></span>
<b>地図の拡大／縮小および移動</b><br>
地図の縮尺はマウスホイールか地図上の＋/ーボタンで変えられ、移動は地図上でマウスをクリックしたまま動かします。<br>
ルートファイルを読込むとその場所に移動します。<br>
作業モードの地図ジャンプで特定の山域に移動でき、
複数のルートが読込まれているときは[読込み済みルート]のルート名をダブルクリックしてそのルートに跳べます。<br>
<br>

<b>ルートの読込み</b><br>
ルートの読込みはルートファイル(GPXまたはKML)を画面上にドラッグ&ドロップ、
またはファイル選択ボタンで開くウィンドウでファイルを選びます。
<a href="#read">詳細</a><br><br>

<b>ルートの編集</b><br>
最初に目的とする作業モード選択の項目をクリック、次に地図上の編集するルートをクリックして選択し（入力ルートが１本でも）
設定や変更を行った後に確定という手順になります。
ルート作成の場合は目的の場所で地図をクリックして作成を始めます。

<a href="#work">詳細</a><br>
<a href="#work2">【各作業モード、動作の説明】</a><br>
<br>

<b>リセット</b><br>
ルートを編集できない、フリーズする等の異常動作の場合はリセットしてください。
<a href="#reset">詳細</a><br>
<br>

<h4 id="read">【ルートファイルの読み込み】</h4>
GPX形式とKML形式のルートファイルに対応しています。<br>
ファイルを読込むとルートが赤線で示されます。ルート端のマゼンタのドット(<font color="magenta">●</font>)が開始点、
ブルーのドット(<font color="steelblue">●</font>)が終了点を示します。<br>
ルートが複数のトラックで構成されているときは開始点/終了点のマーカーも各トラックに表示されますが、
重なってどちらかが見えない事もあります。<br>
読込むルートの数に制約はなく、ドラッグ＆ドロップで複数のファイルをまとめて入力できます。
入力したファイルの名前がルート名になり[読込み済みルート]の下にリストが表示されます。
（ルートやトラックの概念は<b><a href="#GPXdesc">こちら</a></b>を参照ください）<br>
<br>

既に同じ名前のルートが読み込まれている場合、ルートが異なっていても読み込めません。
どちらかのルートの名前を変更してください。<br>
（入力ファイル名を変更するか、読み込んでいるルートの名前を作業モード「名前変更」で変えてください）<br>
名同じ軌跡のルートでも名前が異なれば読込めますが、軌跡が重なるため後から読込んだルートしか選択できません。<br>
部分編集で軌跡を一部変更して軌跡の異なる部分を作れば選択できるようになります。<br>
<br>
KMLファイルは国土地理院地図およびGoogle Mapのフォーマットでのみ検証しています。<br>
KMLファイルに&lt;Point&gt;タグの情報があればウェイポイントに変換されますが、
ポリゴンやポップアップ、イメージへのリンク等、その他の情報は削除されます。<br>
 また、&lt;Placemark&gt;タグが&lt;Point&gt;だけのKMLファイルは読込めません。<br>
<div style="text-align: right"><a href="#top" >トップに戻る</a></div>

<h4 id="work">【編集作業】</h4>
作業モードを選び、目的のルートをクリックするとモード選択パネルの下にルートの名前と関連情報が表示されます。<br>
作業別に必要な設定や変更を行い確定(または実行)をクリックします。<br>
編集は読み込んだデータで行われ、元のGPXファイルには何の変更もしません。<br>
各変更設定は作業を確定する前に作業モードを変更すればキャンセルできます。<br>
ルート削除とウェイポイントの追加および削除は確定をクリックしなくても実行されます。<br>
<br>
<b><font color="red">＊</font>編集を終えても確定前に作業モードを変更すると、それまでの作業が消えますのでご注意ください。</b><br>
<br>
結合以外の作業モードでは、ルートが選択されているときは新たにルート選択はできません。
選択ルートの変更は選択されているルートを再クリックするか、作業モードを一度別モードに変更してキャンセルしてください。<br>
<br>
各編集を確定すると、選択したルートの色が変わっていたものは赤に戻り、
編集用のマーカーがあれば消え、設定入力項目が初期画面になります。<br>
編集前のルートは消去されます。必要に応じて元のファイルを再度読み込んでください。
<div style="text-align: right"><a href="#top" >トップに戻る</a></div><br>

<h4><span id="work2">【各作業モード、動作の説明】</span></h4>
<div style = "margin-left:4em;" >
	<a href="#make">ルート作成</a><br>
	<a href="#edit">部分編集</a><br>
	<a href="#divide">分割</a><br>
	<a href="#remove">部分削除</a><br>
	<a href="#merge">結合</a><br>
	<a href="#decimate">間引き</a><br>
	<a href="#TmChang">時間変更</a><br>
	<a href="#NaChang">名前変更</a><br>
	<a href="#Waypt">ウェイポイント</a><br>
	<a href="#reverse">逆ルート</a><br>
	<a href="#EleRepl">標高置換</a><br>
	<a href="#Pinfo">ポイント情報</a><br>
	<a href="#save">ファイル出力</a><br>
	<a href="#delete">ルート削除</a><br>
	<a href="#jump">地図ジャンプ</a><br>
	<a href="#other">その他</a><br>
</div>
<br><br>

<h4>【編集モード詳細】</h4>
<span id ="make"><b>ルート作成</b></span><br>
新規にルートを作成するモードです。<br>
地図をクリックした点にマーカが表示され、ルートを引きたい場所を順次クリックして行くと、マーカーが青いラインでつながって行きます。<br>
（クリックポイントの標高データをダウンロードしているため反応が0.1～0.2秒程度遅れる事があります。）<br>
青いラインは仮のルートでマーカーの追加／消去／移動により自動的に変更されます。<br>
<br>
マーカの消去はクリック、移動はドラッグで行います。
マーカー間に新たにマーカーを追加することはできません。<br>
(部分編集モードではできるので、最初は粗くルートを作成し、後で詳細を決める事もできます。）<br>
<br>
ルートの入力が終了したら、ルートとトラックの名前、スタートとゴールの時間を設定して「確定」ボタンを押すとルートが赤線に変わります。<br>
デフォルトで表示されている名前は必要に応じ適宜変更してください。<br>
（名前変更で変えられるので、そのままでも構いません）<br>
トラック名はブランクにできますがルート名は必須です。
名前は[読込み済みルート] のリストに無い名前にしてください。<br>
<br>
時間設定は日付を跨いで設定できません。
数日にわたるルートを作成する場合は、日付毎にルートを作成して結合するか、時間を適当に設定して全行程のルートを作り、
それを分割して個々の日時を変えた後に結合します。<br>
<b><font color="red">＊</font>「確定」を押す前に作業モード選択を変更すると、それまでの作業が全て消えますのでご注意ください。</b><br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>


<span id ="edit"><b>部分編集</b></span><br>
ルートの部分変更を行うモードです。<br>
目的ルートの変更したい部分をクリックすると、そこを中心に前後３００ポイントがマーカーに変わり、仮のルート(青ライン)が表示されます。<br>
編集範囲はトラック単位で６０１ポイント、トラックの総ポイント数が６０１以下の場合はトラック全体が編集範囲になります。<br>
クリック点がトラックの端に近い場合、クリック点から端までは３００ポイント以下になります。<br>
<br>
ルートの変更はマーカーの移動／追加／削除で行います。<br>
削除はマーカーをクリック、移動はドラッグします。始点と終点は移動できますが削除はできません。<br>
ウェイポイントが設定されているポイントのマーカーを移動／削除すると、ウェイポイントも移動／削除されます。<br>

マーカーの追加は青ラインをクリックすると、そこに追加されます。
ライン以外の場所にマーカは追加できませんので、別の場所にマーカーを置く場合はライン上に追加して移動してください。<br>
マーカーを移動や削除すると仮のルートは変わりますが、
元ルートの赤いラインは「確定」ボタンを押すまでそのまま残っています。<br>
編集を中止したいときは確定せずに作業モードを変更してください。<br>
<br>
追加したマーカーの標高は地理院のサーバーからダウンロードされ、
時間は前後のマーカーの時間が標高差と距離に応じて配分された値になります。<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="divide"><b>分割</b></span><br>
ルートを２つに分割するモードです。<br>
分割したい地点をクリックすると、そこに一番近いトラックポイントに分割マーカーが付きます。
マーカーは再度クリックするとキャンセルできます。<br>
分割後のルート名を設定し確定するとマーカーが消えルートが分かれます。
分割後のルートは ”開始点からマーカーの前まで” と ”マーカーから終了点まで” になります。<br>

分割後のファイル名に分割前の名前や読込んでいる他のルートと同じ名前は使えません。<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="remove"><b>部分削除</b></span><br>
ルートの一部を削除するモードです。<br>
マーカーを2つ設定して削除する部分を選び、確定すればその部分が削除されます。
マーカーの設置に順序はなく、キャンセルはマーカーをクリックします。<br>
始点からマーカーまで、およびマーカーから終点までを削除する場合はマーカーは1つで構いません。<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="merge"><b>結合</b></span><br>
２つのルートを結合するモードです。<br>
複数のトラックに分かれているルートのトラックを1つに統合する事もできます。<br>
結合はルートを2つクリックして選択し、結合方法を選んで確定します。<br>
選択ルートのキャンセルはルートを再度クリックします。<br>
トラックの単純接続以外は時系列に結合するためルートに時間データが入っている必要があります。<br>
<br>
結合方法は次の通りです。<br>
　<b>・</b>トラックを統合して結合：<br>　　　２つのルートのトラックを全て統合して時系列に結合します。<br>
　<b>・</b>トラックを時系列で結合：<br>　　　それぞれのルートをトラック単位で時系列に結合します。<br>
　<b>・</b>トラックの単純接続：<br>　　　それぞれのルートのトラックを単純に結合します。<br>
<br>
ルートに複数のトラックがあってその構成を残したい場合、または接続したルートが分かるようにしたい場合などは
「ラックを時系列で結合」を選択してください。<br>
複数のルートをまとめたファイルを作る場合は「トラックの単純接続」を選択します。<br>
<br>
ルート内の複数トラックを1つ統合する場合は
ルートを1つだけ選択し「トラックを統合して結合」で結合してください。<br>
この場合は結合後のルート名は設定する必要はなく、設定してもルート名は変わりません。<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="decimate"><b>間引き</b></span><br>
選択したルートのトラックポイント(trkpt)を指定した間隔(m)で間引きます。<br>
間隔はポイント間の距離を積算して判断しているため正確ではなく多少の誤差を含みます。<br>
トラックの終端とウェイポイントがある場合は、その前のポイントとの間隔が指定した値より短くなります。
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="TmChang"><b>時間変更</b></span><br>
ルートの各ポイントの時間を、始点から終点まで時間を距離と標高差に応じて配分したものに置き換えます。
変更する日付、開始時間、終了時間を設定し変更を押します。<br>
日付を跨いだ設定はできません。その場合は日付毎にルートを分割して個別に設定してから結合してください。<br>
<br>
日付や時間をシフトする事もできます。この場合は日付と開始時間だけを設定します。<br>
入力に秒の桁を設けていないので、時間シフトの結果は設定値から秒数分だけずれます。<br>
<br>
時間配分の比率はソースファイルの定数を変更すれば変えられます。<br>
（<a href="#other">その他</a>のカスタマイズを参照してください）<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="NaChang"><b>名前変更</b></span><br>
ルートとトラックの名前を変更します。<br>
ルートを選択すると現在のルート名とトラック名が表示されます。それを変更してください。<br>
ルート名にWindowsのファイル名で使えない文字も入力できますが、ルートをその名前で保存すると使えない文字はアンダースコア（ _ ）に置き換わります。<br>
<br>
トラック名は<br>
　　&lt;name&gt;名前(半角、全角いずれも可)&lt;number&gt;番号(半角)<br>
の書式でトラック数と同じ行数で記述して下さい。<br>
トラック名もnumberもブランクにできますが、その場合でも&lt;name&gt;&lt;number&gt;の形にしてください。<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br><br>

<span id ="Waypt"><b>ウェイポイント</b></span><br>
ウェイポイントを編集するモードです。<br>
編集できるのは名前(&lt;name&gt;タグ)、コメント(&lt;cmt&gt;タグ)、説明(&lt;desc&gt;タグ)だけです。
(その他の情報はルート読込み時に削除されています。)<br>
ルートを選択するとラインの色が変わり、ルートにウェイポイントがあればマーカーが置かれます。<br>
選択ルートの変更（キャンセル）、および編集モードを抜けるには作業モードをもう一度クリックするか、別の作業モードを選択します。<br>
<br>
マーカーはクリックすると、そのポイントの情報が示されます。必要に応じて変更して確定を押してください。<br>
ウェイポイントの追加はライン上の設置したい場所をクリックしてください。削除はマーカーを右クリックします。<br>
マーカーの追加／削除はクリックした時点で行われ、途中で作業モードを変更してもキャンセルされません。<br>
<br>
部分編集モードと部分削除モードでウェイポイントの設定されているポイントを削除／移動すると、ウェイポイントも削除／移動されます。<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="reverse"><b>逆ルート</b></span><br>
選択したルートの始点と終点を反転します。<br>
時間データが失われますので、変換後に時間変更で再設定してください。<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="EleRepl"><b>標高置換</b></span><br>
標高の値を国土地理院地図の値に置き換えます。<br>
GPSの受信エラーで標高値が異常になったGPXファイルや、標高値を持たないGoogleマップのKMLのルート等で使えます。
標高値は約５ｍメッシュのDEM5A、そのデータが無い場所は約１０ｍメッシュのDEM10Bになります。
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="Pinfo"><b>ポイント情報</b></span><br>
ルートをクリックした点に一番近いトラックポイントの情報が示されます。indexはポイントのトラックでの順序で0からの連番です。<br>
ポイントの時間は変更できますが、前後のポイントとの時間の関係がずれるとアプリによってはルートが乱れますので注意してください。<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="save"><b>ファイル出力</b></span><br>
ルートをファイルに出力します。<br>
出力するルートを選択するとファイル名欄に xxxxx_ed (xxxxは元のファイル名) が表示され、
保存ボタンを押すとダウンロードフォルダにGPXファイルが出力されます。
ファイル名は自由に変更できます。<br>
<br>
「元ファイル形式で保存」「最小サイズで保存」の選択で「最小サイズで保存」を選ぶと、
トラックポイント(trkpt)のデータが緯度経度／標高／時間だけになり、
付加されている情報や改行が省かれてファイルサイズが小さくなります。<br>
通常はどちらでも問題ありませんが、最小サイズでは付加情報が無くなるので、それを使っているアプリで情報が出なくなります。<br>
それぞれ(wpt無)を選ぶとウェイポイントが除去されます。
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="delete"><b>ルート削除</b></span><br>
選択したルートを地図と「読込み済みリスト」から削除します。<br>
確認等は無く、ルートをクリックすると即削除されます。<br>
編集したルートを保存してない時には注意してください。<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="jump"><b>地図ジャンプ</b></span><br>
表示される山域をクリックすると地図がその山域に移動し、縮尺も変わります。<br>
山域や縮尺はソースファイルの定数を変更すれば変えられます。<br>
（<a href="#other">その他</a>のカスタマイズを参照してください）<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>
<br>

<span id ="other"><b>【その他】</b></span><br>
<br>
<b>リストジャンプ</b><br>
複数のルートを読み込んでいる時、[読込み済みルート]に示されているルート名をダブルクリックすれば、その場所にジャンプできます。<br>
ただし、ダブルクリックして選択できる文字列の範囲がブラウザによって異なるため、同じ文字が使われているルートがある場合は目的のルートに
ジャンプしない事があります。
ルート名で異なる文字をクリックするようにしてください。<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div>

<b>カスタマイズ</b>
下記の2つはカスタマイズできます。<br>
メモ帳等のテキストエディタでmodule1.jsファイルを開き、ソースコードの定数を変え、ファイルを上書き保存して下さい。
なお、保存するときは文字コードをUTF8(BOMなし)にしてください。<br>
<br>
<b>（1）時間変更の時間配分</b><br>
module1.jsファイルの２行目からの傾斜に対する速度比および傾斜レンジの閾値を変えれば、ルート作成や時間変更での時間配分も変わります。<br>
これらの値を自分の速度に合わせた値にすることで、欠落したGPSログを補完するときに時間配分が実際に近いものになります。<br>
<br>
<div style = "margin-left: 2em;" >
<table>
	<tr><td>const SrUpS  = 0.5; </td><td>急な上りの速度比(平地を1として)</td></tr>
	<tr><td>const SrUp   = 0.8; </td><td>上りの速度比</td></tr>
	<tr><td>const SrDwn  = 1.15;</td><td>下りの速度比</td></tr>
	<tr><td>const SrDwnS = 0.85;</td><td>急な下りの速度比</td></tr>
	<tr><td>const UpTh1  = 0.04;</td><td>上り傾斜のしきい値(4m/100m)</td></tr>
	<tr><td>const UpTh2  = 0.5;</td><td>急な上り傾斜のしきい値(50m/100m)</td></tr>
	<tr><td>const DwnTh1 = -0.04;</td><td>下り傾斜のしきい値</td></tr>
	<tr><td>const DwnTh2 = 0.5;</td><td>急な下り傾斜のしきい値</td></tr>
</table>
</div>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<b>（2）地図ジャンプ先変更</b><br>
地図ジャンプの飛び先は、ソースコード17行目からのjumpListの配列の値を変更することにより増やす場合ことも減らすこともできます。
増やす場合は定数を追加し、減らす場合は不要な定数を削除してください。<br>
変更する際には閉じカッコとセミコロン（ ]; ）を消さないように注意してださい。<br>
ジャンプ先定数の記述フォーマットは、ジャンプ先名称(適当な名前を付けます)、地図縮尺値、ジャンプ先緯度経度をスラッシュ(/)で区切り、それをダブルクォーテーションで囲ってカンマで区切ったものです。(改行はしても、しなくてもOKです）<br>
　記述例：<br>
　　"奥多摩/12/35.779436/139.127785",<br>
<br>
縮尺値や緯度経度は国土地理院の地図( https://maps.gsi.go.jp/ )で目的の場所を表示したとき、アドレス欄に出ているurlで、#に続く3つの数値をコピーすればジャンプ先も同じ場所とスケールになります。<br>
<br>
　国土地理院地図のurlの例：<br>
https://maps.gsi.go.jp/#13/35.711117/137.821426/&base=std&ls=std&disp=1&vs=c1j0h0k0l0u0t0z0r0s0m0f1<br>
<div style="text-align: right"><a href="#work2" >戻る</a></div><br>

<span id ="reset"><b>【リセット】</b><br>
リセットはブラウザでリロード(再読み込み)するか、タブを閉じて再度立ち上げてください。<br>
入手し得えた範囲のGPXファイルで動作チェックしていますが、GPXファイルの書式によっては予期しない動作になる可能性も残っています。<br>
例えば、ルートは表示されても読み込みリストに出てこない、読込みリストにあっても地図に表示されない、編集作業ができない等。
そのような場合にはリセットしてください。<br>
リセットが必要になったGPXファイルは編集できない可能性が高いので、テキストエディタ等の他のツールの使用をお勧めします。
<div style="text-align: right"><a href="#top" >戻る</a></div><br>
<br>

<span id ="GPXdesc"><b>【参考】GPXファイルについての簡易的な説明</b><br>
GPXファイルは、ある地点の緯度経度や標高、時間、その他のデータが含まれるtrkpt(トッラクポイント)を時系列に並べ、
そのtrkptを線でつなぐ事により経路(ルート)を表しています。<br>
trkptの集まりはtrkseg(トラックセグメント)としてくくられ、それに名前(無い事もあります)を付けたものがtrk(トラック)で、
そのtrkが１つ以上入ったものがGPXファイルになります。<br>
<br>

GPXファイルはXML形式で記述されたテキストファイルで、内容はメモ帳（ノートパッド）等のテキストエディタで編集できます。<br>
<div style="text-align: right"><a href="#top" >トップに戻る</a></div><br>


  </body>
</html>

